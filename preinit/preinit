#!/bin/bash
# shellcheck disable=SC2004,SC2009,SC2068,SC2002
# shellcheck disable=SC1091

# Set the TESTME variable to non zero if you are in a
# simulation / test environment. Warning: script will not work in the real env.
#TESTME=1

# Silence async messages on terminal
/usr/bin/setterm --msg off

# Silence comments and commands on terminal
set +x; set +v

export PATH="/sbin:/bin:/usr/sbin:/usr/bin"

# ------------------------------------------------------------------------
# Ended up with ONE separate file. (for accomodating unit tests):

if [ $(($TESTME)) -gt 0 ] ; then
    .  ./preinit.sh
else
    .  /sbin/preinit.sh
fi

echo "Booting Community Linux, Lib version: $LIBVERS"

# The following breakpoints are active from the kernel command line:
#    initbreak=start    "At the start of this script $"
#    initbreak=deemons  "Before starting daemons $ "
#    initbreak=modules  "Before installing modules $ "
#    initbreak=devices  "Before installing devices $ "
#    initbreak=network  "Before starting network $ "
#    initbreak=sound    "Before starting sound $ "
#    initbreak=pre-gui  "Before starting GUI $ "
#    initbreak=post-gui "After XFCE loop iteration $ "
# Other variables:
#    bsleep=sec         "sleep after commands for visual observation"
#    verbose=lev        "verbosity level"
# There are more break ITEMS, see source below

# History:  Tue 14.Jan.2025     Sound works, created /dev entries by hand
#           Sun 19.Jan.2025     Added TESTME subsystem + shellcheck
#           Tue 21.Jan.2025     Cleanup (quote errors in bash are difficult)

export HOME=/root
export USER=root

cd $HOME || echo "Warn:" cannot cd to $HOME >&2

mkdir -p /var/tmp
SDCOM="/var/tmp/.shutdowncmd"

# Log files for startup
export SUL="/.startuplogs"

mkdir -p $SUL
SULERR=$SUL/log_err;
SULOUT=$SUL/log_out

# Create blanks for append
echo "" > "$SULOUT"
echo "" > "$SULERR"

# Never leave us hanging without a name
hostname "localhost"  >>$SULOUT 2>>$SULERR

# Patch some basic terminal environmental vars
export TERM=linux
export PS1="ComLin \w # "
export COLUMNS=80 ; export ROWS=24

# Mount some (important) things on new root
mount -t proc -o nosuid,noexec,nodev proc "$NEWROOT/proc" >/dev/null 2>&1
mount -t sysfs -o nosuid,noexec,nodev sysfs "$NEWROOT/sys" >/dev/null 2>&1
mount -t devpts -o gid=5,mode=620 devpts "$NEWROOT/dev/pts" >/dev/null 2>&1

getargx 'initbreak=start' && tmpshell "$FOUNDVAR $ "

# Determine overall flags for operation
getargy 'verbose' && export VERBOSE=$FOUNDVAL
getargx 'initbreak=all' && export BREAKALL=1

# Remove what is left of the old root (return later)
# This method frees the resources without effecting other processes
#rm -r /var/oldroot/*  >/dev/null 2>&1
# And no more traces
#umount /var/oldroot >/dev/null 2>&1

# We create this dynamically
export XDG_RUNTIME_DIR=/run/user/$UID
mkdir -p $XDG_RUNTIME_DIR

mkdir -p /run/dbus
echo -n "Starting DBUS ... "
dbus-daemon --system #>>"$SULOUT" 2>>"$SULERR"
getargy 'bsleep' && sleep "$FOUNDVAL"
echo " OK"

# Start logging
echo -n "Starting rsyslogd ... "
rsyslogd >> "$SULOUT" 2>> "$SULERR"
getargy 'bsleep' && sleep "$FOUNDVAL"
echo " OK"

# UP loopback network connection
ifconfig lo up 127.0.0.1

# Virtual terminals and a serial port
echo -n "Starting VTs ... "
startvts
getargy 'bsleep' && sleep "$FOUNDVAL"
echo " OK"

#export PS1="Comlin \w$ $ " ; setsid -c -w /bin/bash

# This way udev is functional in chroot
export SYSTEMD_IGNORE_CHROOT=1

# Polkit, udev, etc ...
getargx 'initbreak=daemons' && tmpshell "$FOUNDVAR $ "
echo -n "Starting daemons ... "

#echo -n "polkit "
#/usr/libexec/polkitd >>$SULOUT 2>>$SULERR &
#getargy 'bsleep' && sleep "$FOUNDVAL"

echo -n "systemd-udevd "
/lib/systemd/systemd-udevd >>$SULOUT 2>>$SULERR &
getargy 'bsleep' && sleep "$FOUNDVAL"

#echo -n "systemd-logind "
#/lib/systemd/systemd-logind >>$SULOUT 2>>$SULERR &
#getargy 'bsleep' && sleep "$FOUNDVAL"

echo " OK"

getargx 'initbreak=modules' && tmpshell "$FOUNDVAR $ "

# Install devices specified by the user's /etc
echo -n "Installing modules ... "
loadmods
getargy 'bsleep' && sleep "$FOUNDVAL"
echo " OK"

getargx 'initbreak=devices' && tmpshell "$FOUNDVAR $ "

# Install devices from PCI bus; ignore vbox additions for now
echo -n "Installing devices ... "
loaddevs
getargy 'bsleep' && sleep "$FOUNDVAL"
echo " OK"

getargx 'initbreak=sound' &&  tmpshell "$FOUNDVAR $ "
echo -n "Starting sound system ... "
makedevices
getargy 'bsleep' && sleep "$FOUNDVAL"
echo " OK"

echo -n "Setting sound voulume  ... "
pulseaudio --start >>$SULOUT 2>>$SULERR
pactl set-sink-mute 0 0
pactl set-sink-volume 0 0.5
getargy 'bsleep' && sleep "$FOUNDVAL"
echo " OK"

getargx 'initbreak=network' && tmpshell "$FOUNDVAR $ "
echo -n "Starting network ... "
dhclient >>$SULOUT 2>>$SULERR &
getargy 'bsleep' && sleep "$FOUNDVAL"
echo " OK"

# After all configured, let it write some
#/usr/bin/sync

getargx 'initbreak=pre-gui' && tmpshell  "$FOUNDVAR $ "

# Xorg needs these
export XAUTHORITY=/root/.Xauthority
export ICEAUTHORITY=/root/.ICEauthority

pulseaudio --session >>$SULOUT 2>>$SULERR

while : ; do

    rm -f $SDCOM                # Fresh start

    echo -n "Starting GUI ... "
    getargy 'bsleep' && sleep "$FOUNDVAL"
    #dbus-launch lightdm

    /usr/bin/startxfce4 -- -keeptty -novtswitch  >"$SUL/xfce_out" 2>"$SUL/xfce_err"
    #/usr/bin/startxfce4 >"$SUL/xfce_out" 2>"$SUL/xfce_err"

    echo " OK"

    #sleep 8; killall Xorg      # TEST: kill it, see what comes back
    chvt 1

    # Here one can examine post - cleanup
    getargx 'initbreak=post-gui' &&  tmpshell "$FOUNDVAR $ "

    # Shutdown?
    if [ -e $SDCOM ] ; then
        shutdownx
    fi

    # If it got here, it is a logout or shutdown error
    echo "Exit this shell to continue."
    tmpshell "XFCE loop iteration $ "

    #sleep 1
    #export PS1="Comlin Post GUI \w$ $ " ; setsid -c -w /bin/bash

done

# Can not reach this ... just in case

# Start a shell for recovery / diagnosis
export PS1="Comlin PreInit fallback: \w $ "
while : ; do
   setsid -c -w /bin/bash
   echo "Spawning new shell $$ \w # "
   sleep 1
done

# EOF
